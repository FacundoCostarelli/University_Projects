# Pulseoxímeter - Integrated Proyect

**Brief Description:**  
Development of a prototype pulse oximeter device that combines basic software and hardware. 
This project measures blood oxygen saturation (SPO2) and heart rate using the MAX30102 sensor, the LPC845 microcontroller, and the ESP8266 module for WiFi transmission to a PC. 
It includes a Qt graphical interface for data visualization.
- [Youtube presentation PulseOximeter pt1](https://youtu.be/URdDrjCLyfk)
- [Youtube presentation PulseOximeter pt2](https://youtu.be/5oK6cyuanyA)

---

## Table of Contents

1. [Installation](#installation)
2. [Usage](#usage)
3. [Common Issues](#common-issues)
4. [Documentation](#documentation)
5. [References](#references)
6. [Contribution](#contribution)
7. [License](#license)
8. [Authors](#authors)
9. [Acknowledgments and Collaborations](#acknowledgments-and-collaborations)

---

## Installation
A written guide on how to install the software and set up the Pulse Oximeter kit is provided.
A link to a YouTube playlist with explanatory videos for each installation step is also included.
[YouTube tutorial PulseOximeter](https://www.youtube.com/watch?v=URdDrjCLyfk&list=PLJ6_LB1a1MI0CGqnPWMbReCNobSWlScEj&pp=gAQB)

**Prerequisites:**
- LPC845 microcontroller and MAX30102 sensor.
- Sensor coupling hardware module designed in KiCad.
- ESP8266 module configured with AT commands.
- 3.3V power supply.
- Required software:
    - [Qt Creator](https://www.qt.io/) 
    - Qt --> Version 6.4.2 or higher.
    - [MCUXpresso IDE](https://www.nxp.com/design/software/development-software/mcuxpresso-integrated-development-environment-ide:MCUXpresso-IDE)
    - MCUXpresso IDE --> Version MCUXpresso IDE v11.10.0 [Build 3148] [2024-07-03] or higher.

**Installation Steps:**
1. Clone the repository:
        git clone https://github.com/FacundoCostarelli/University_Proyects/tree/master/Pulse_Oximeter
2. Configure the LPC845 software package and MCUXpresso IDE pre-execution:

    **MCUXpresso IDE Installation:**
    - Go to the official NXP page and download the latest version of MCUXpresso IDE from the link 
    [MCUXpresso IDE](https://nxp.flexnetoperations.com/control/frse/product?entitlementId=715761407&lineNum=1&authContactId=185187057&authPartyId=208677767)
    - Follow the installation steps provided by the IDE installer

    **Project Configuration Option 1:** --> [Project Configuration Video Option 1](https://youtu.be/lj2HqsI22eU) 
    - Generate a .zip file from the Microcontroller folder with the same name as the folder and save it on the desktop or another location.
    - Open MCUXpresso IDE, select the desired workspace. Typically, it defaults to the path:
        C:\Users\your_pc_username\Documents\MCUXpressoIDE_11.10.0_3148\workspace
    - Find the window that says "Create or import a project". Typically located in the bottom left corner.
    - Select "Import project(s) from file system".
    - Choose "Project archive (zip)" and click Browse.
    - In Browse, find the .zip file generated in the first step.
    - Click next, and in the next window, a white box with the project name like SPO2_HR should appear with a tick box next to it.
    - Click finish and then "Yes to all" in the next configuration modification prompt.
    - The project is now open with all configurations and folders containing .cpp and .h files.
    - Compile with the "Hammer" symbol located in the top bar, verify there are no errors, and ignore Warnings.

    **Project Configuration Option 2:** --> [Project Configuration Video Option 2](...............)
    - Open MCUXpresso IDE, select the desired workspace. Typically, it defaults to the path:
    C:\Users\your_pc_username\Documents\MCUXpressoIDE_11.10.0_3148\workspace
    - Create a new project from "File"-->"New"-->"Create a C/C++ project" and choose "Target" as "LPC84x"-->"LPC845".
    - Click "next >" and in the "Wizard selection page" choose "C++ project".
    - In "Project name" give a name, for example, "SPO2_HR" and leave the "Use default location" box ticked. This is necessary to create the project in the workspace path given by default by MCUXpresso IDE during installation.
        - In "Wizard properties page" uncheck "Enable use of RomDivie library by compiled code" and click "Next >".
        - In "Micro Trace Buffer Enable" uncheck "Enable definition of buffer array for MTB".
        - In "Code Read Protection (CRP)" uncheck "Enable linker support for CRP".
    - These last 3 steps are necessary to uncheck these boxes as they are not used in the project and if used, they add memory and resource consumption to the microcontroller which is not desired.
    - The rest of the options should remain in the default configuration.
    - Click "Finish" and wait for the IDE to configure what is necessary.
    - Then, in the "Projects" window on the left, our generated project with its name and subfolders should appear.
    - Now, delete the "src" folder generated by default.
    - Download the "src", "Drivers_LPC845", and "Utils" folders from the repository. You can download the entire repository or just the individual folders. Only these mentioned folders are used now.
    - Copy and paste by right-clicking on the project name, the "src", "Drivers_LPC845", and "Utils" folders located in the Microcontroller folder in the "University_Projects" repository.
    - Right-click on the project folder and select "Properties", then select "C/C++ Build"-->"settings" and from "MCU C++ Compiler"-->"Includes".
    - In "Includes" choose "Include paths" and then "add" (it has a symbol of a sheet with a +). The "Add directory path" window opens, choose workspace.
    - Then, in the "Folder selection" window, find the general project folder named "SPO2_HR". Click and choose each folder and subfolder, one at a time. These are: "src", "Drivers_LPC845","dr_init", "esp8266", "gpio", "I2C", "perifericoTemporizado", "pinInt", "sensor", "SerialCom", "systick", "timer", "Utils", "queue", "strings".
    - All mentioned folders and subfolders must be added one at a time and then click "Apply and close". Repeat the process for each folder.
    - Compile with the "Hammer" symbol located in the top bar and verify there are no errors, ignoring Warnings.
3. Configure the Qt interface and the QT IDE pre-execution:

    **QT Installation:**
    - Go to the official QT page and download the latest version from this link
    [QT IDE](https://www.qt.io/download-open-source)
    - Scroll down the page and choose “Download the Qt Online Installer”.
    - We select the latest version taking care of the selection of the GCC compiler or in case of Windows MinGW.
    - For download and installation you should consider ONLY the following software packages:
        ![QT Software Packages 1](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/QT_GraphicUserInterface/Software%20Packages%20ScreenShots/Picture1.jpeg)
		![QT Software Packages 2](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/QT_GraphicUserInterface/Software%20Packages%20ScreenShots/Picture2.jpeg)
        
4. Configure SSID and IP address of WIFI for ESP8266
    - Remember that this project uses a WiFi network where the mobile phone works as a server in hotspot mode with data roaming where the ESP8266 and the notebook PC are clients. 
    - Configure the mobile phone in hotspot mode and ensure data roaming is enabled.
    - Connect the notebook PC or any PC with WiFi to the phone.
    - In MCUXpresso IDE, find the SPO2_HR project and then "Drivers_LPC845"-->"esp8266"-->"ESP8266.h" look for the section commented as "Connection and TCP server configuration". There, find line 22 and modify the "#define WIFI_SSID "MYNETWORK" to the name of your WiFi network of the phone in hotspot mode. It cannot contain spaces or special characters, or simply leave this name and configure your phone in hotspot mode with the name "MYNETWORK".
    - Find line 24 and modify the "#define TCP_HOST "192.168.116.150", specifically the IP address should be modified according to the one associated with the PC connected to the phone. This can be seen within the hotspot mode from the phone or from the laptop in "properties" of the wifi network and then in IPV4.

5. Assemble hardware and execute the LPC845 software package and the Qt interface application
    - Calibrate the green mini360 DC-DC regulator module below where the LPC845 goes. To do this, turn the small gray screw with a small flat or cross screwdriver. 3.3V must be reached at the regulator output. To verify, connect a direct voltage source to the input and measure the output voltage at the regulator terminals with a voltmeter while turning the screw simultaneously.
    - Place WiFi modules, MAX30102 sensor, and microcontroller on the previously built board. They should be placed on the corresponding pin strips as indicated by the KiCad schematic. 
    - The schematic and 3D modeling can be seen in the PDF file named "oximeter_max30102_LPC845" or at the following link [PulseOximeter Hardware](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/Hardware/oximeter_max30102_LPC845.pdf)

---        

## Usage
Once all installation and configuration steps are completed, the following steps should be performed:

**Usage Steps:**
- Connect the microcontroller with a USB cable to the PC but do not connect any power source to the terminal yet.
- In MCUXpresso IDE, compile the code with the hammer symbol and execute the code with the "Play =" button and then click the red square "terminate" button.
- Open a terminal in MCUXpresso IDE. From "Window"-->"show view"-->"other"-->"terminal"-->"open".
- In QT IDE, open the Interfaz_QT project and run the application in QT with the "Play" button. Then click on "Measurements".
- With the GUI windows of QT and the terminal of MCUXpresso IDE, now connect a continuous voltage source to the blue terminal. It should have one of the following values: 5V or 9V or 12V. 
    It can also have a continuous voltage value between 5V and 20V. A 5V laboratory power supply or a 9V battery is recommended.
- Apply a reset to the LPC. Press and hold the reset button (black) on the LPC845 board for 2 seconds and release.
- If everything goes well, and with some delay, a series of AT commands and "OK" responses from the module should be seen in the MCUXpresso IDE console.
- If the information is being sent correctly, messages like:
        ...
        ...
        ...	
        ...	
        ...
- If there are data transmission issues, then reset as many times as necessary.
- View the data in the QT GUI. Observe real-time SPO2 and heart rate values processed in the Qt interface.
- Keep in mind that:
    - The first SPO2 and HR data should be discarded from observation. The measurement process stabilization requires a few seconds of delay.
    - Data refresh is every half second. This can be modified.
    - When a data value is repeated multiple times in the measurement, the value is shown but not refreshed until a new change in the measurement appears, to avoid unnecessary data repetitions.
    - To save measurements, click "Save" in the interface to store the data locally in a file. 
    - A file storing each patient's data is obtained. The data of each patient can be modified from a txt notepad or from the interface in the "edit" button.

---

## Common Issues
1. Device issues during research:
    - Description: Difficulty finding affordable, easy-to-program devices with adequate technical support.
    - Solution: Collaboration with the GBIO laboratory, which provided the MAX30102 sensor and the ESP8266 WiFi module, both previously successfully used by other students.
2. Noise and false contact in the hardware prototype:
    - Description: Communication noise issues due to long cables on the protoboard and false contact between modules.
    - Solution: Design of a PCB that fixed the modules and used short tracks. A battery was used instead of a laboratory power supply.
3. Overload in module power supply:
    - Description: High current demands from the WiFi module caused overheating and damage to the microcontroller and WiFi module.
    - Solution: Separate power supplies: the regulator powers the MAX30102 sensor and the ESP8266, while the microcontroller uses a USB connection.
4. WiFi module configuration with TTL adapters:
    - Description: The FTDI232 adapter did not work correctly, making it difficult to view AT commands.
    - Solution: Use the UART console of the MCUXpresso IDE to configure the ESP8266.
5. Overcurrent in the WiFi module:
    - Description: ESP8266 current peaks exceeded 200 mA, causing instability.
    - Solution: Use an appropriate regulator and a 100 µF capacitor to dampen the peaks.
6. I2C communication issues:
    - Description: Difficulties synchronizing the sending of addresses and data to the MAX30102 sensor.
    - Solution: Introduce delays between commands, use a logic analyzer for debugging, and consult NXP forums and libraries.
7. Complex configuration of the MAX30102 sensor:
    - Description: Unclear documentation on the use of FIFO pointers and the configuration order.
    - Solution: Conduct extensive testing and consult previous projects to identify the correct order.
8. WiFi module programming issues:
    - Description: Difficulties with the communication pattern, AT commands, and use of blocking functions.
    - Solution: Implement a state machine to handle "OK\r\n" responses and a queuing system to transmit messages.

---

## Documentation
For more information and details, it is suggested to consult the following links. You can also check the "DocumentsAndDatasheets" folder within the "Pulse_Oximeter" folder in the "University_Proyects" repository.

- [Main Idea Report in ENG](..................)
- [Technical Report in ENG](..................)

For more technical details, consult the component datasheets:

- [Datasheet Module MAX30102](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/Module_MAX30102_Datasheet.pdf)
- [Recommended Configurations Module MAX3010x](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/Module_MAX3010x_ev_kits_recommended_configurations_and_operating_profiles.pdf)
- [Datasheet Module ESP8266](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/Module_ESP8266_Datasheet.pdf)
- [Instruction Set ESP8266](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/Module_esp8266_at_instruction_set_en.pdf)
- [Command Examples ES8266](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/Module_esp8266_at_command_examples_en.pdf)
- [Datasheet Module LPC845](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/LPC84X_User_Manual.pdf)
- [Datasheet Breakout Board LPC845](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/LPC845_Breakout_board_User_Manual.pdf)
- [Schematic Breakout Board LPC845](https://github.com/FacundoCostarelli/University_Proyects/blob/master/Pulse_Oximeter/DocumentsAndDatasheets/Schematic_LPC845_BRK_RevA.PDF)

---

## References
- [NXP Forums on LPC845](https://community.nxp.com/t5/forums/searchpage/tab/message?advanced=false&allow_punctuation=true&q=LPC845)
- [StackOverflow Forums](https://stackoverflow.com/)
- [Chat GPT PLUS](https://chatgpt.com/)

Note: We mainly used forums and some help from ChatGPT AI. It is necessary to mention that ChatGPT generally does not work well for microcontroller programming.
It is necessary to send some files, ideas, and code developed by the programmer without AI help at least in prototype form to receive clear help from the AI. 
It is recommended to send even working code blocks and ask for specific help in certain sections and then take the help.
It is not recommended to copy and paste as the provided C and C++ code will likely not work when applied to the specific microcontroller.
It is recommended to take the provided code structure, lines of code, and specific functions as a reference but with necessary modifications according to the microcontroller's datasheet.

---

## Contribution

All contributions are welcome. Follow these steps to contribute:

1. Fork the repository.

2. Create a new branch for your feature or fix:
    - git checkout -b feature/new-feature
3. Make your changes and commit:
    - git commit -m "Description of the changes made"
4. Push to:
    - git checkout -b feature/nueva-caracteristica
5. Create a Pull Request describing your changes.

---

## License
This project is licensed under the GNU General Public License v3.0. 
You can use, modify and distribute this project respecting the terms of the license.

---

## Authors
- Facundo Costarelli

---

## Acknowledgments And Collaborations
- UTN BA Bioengineering Laboratory [UTN BA-GBIO website](https://www.frba.utn.edu.ar/gibio/)
- Prof Doctor Ing Leandro Cymberknop            (Electrónics at UTN BA)
- Prof Ing Mariana Prieto                       (Electrónics at UTN BA)
- Prof Ing Jorge Escola                         (Electrónics at UTN BA)
- Engineering Student Juan Lauría               (Electrónics at UTN BA)
- Engineering Student Nahuel Contreras          (Electrónics at UTN BA)
- Engineering Student Maximiliano Montenegro    (Electrónics at UTN BA)
- Engineering Student Matias González Falbo     (Electrónics at UTN BA)
- Engineering Student Franco Callero            (Informátics & Sistems at UTN BA)
- Engineering Student Ezequiel Lagatche         (Electrónics at UTN BA)
- Engineering Student Guido Rodriguez           (Electrónics at UBA)

**Abreviaciones:**
- UTN BA-->National Technological University of Buenos Aires.
- UBA   -->University of Buenos Aires.